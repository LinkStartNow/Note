# 例题——学生们参加各科测试的次数

> Problem: [1280. 学生们参加各科测试的次数](https://leetcode.cn/problems/students-and-examinations/description/)

## 步骤

### 1、绑定学生与课程

> 观察要求输出我们可以看到，最终每个同学都要统计三门课的次数，即使没有去考试，次数也需要为0
>
> 所以我们要先将他们绑定起来，这就用交叉连接就可以将两个表所有的行排列组合搭配在一起

```mysql
select
    *
from
    Students
cross join
    Subjects
```

---

### 2、查出每个学生考试的次数

> 第二步我们需要查询出每个学生对应的考试次数，这通过分组就能实现

```mysql
select
	e.student_id, e.subject_name, count(*) as cnt
from
	Students as s
left join
	Examinations as e
on
	s.student_id = e.student_id
group by
    e.student_id, e.subject_name
```

----

#### 细节

> 分组的条件应该将学生学号和课程都绑定在一起，不然所有学生的所有课都会被加在一起

### 3、合并

> 最后，我们将这俩表合并在一起，然后选定合适的行就能出结果了

```mysql
select
    Students.student_id, Students.student_name, Subjects.subject_name, ifnull(yyds.cnt, 0) as attended_exams
from
    Students
cross join
    Subjects
left join (
    select
        e.student_id, e.subject_name, count(*) as cnt
    from
        Students as s
    left join
        Examinations as e
    on
        s.student_id = e.student_id
    group by
    e.student_id, e.subject_name
) as yyds
on
Students.student_id = yyds.student_id and Subjects.subject_name = yyds.subject_name
order by
Students.student_id, Subjects.subject_name
```

---

#### 细节

> 左连接是为了让某些没有考试次数的学生得出空值，这样方便判断学生考试次数
>
> 连接的条件也要同时加上学号和课程名的限制。否则，也会出现之前的情况，一个同学的好多课程都加到该同学的一个记录中无法区分
>
> 最终选择输出的列名也要注意前缀，到底是来自哪个表的，这会影响到最后的结果

---

# 例题——确认率

> Problem: [1934. 确认率](https://leetcode.cn/problems/confirmation-rate/description/)

## 法1——sum求和

### 1、求出每个人的总action数

> 通过分组和count函数可以直接求出每个用户的总action数
>
> 这里通过左连接可以让没有action的用户的action数变成0

```mysql
select
    s.user_id, count(c.action)
from
    Signups as s
left join
    Confirmations as c
on
    s.user_id = c.user_id
group by
    s.user_id
```

---

### 2、求出每个人的确认数

> sum函数可以用来求和，我们传入表达式为action值为confirmed，这样可以将action为confirmed的行返回1，其他返回0，再求和便可以巧妙计算出confirmed行数

```mysql
select
    s.user_id, count(c.action), sum(c.action = 'confirmed')
from
    Signups as s
left join
    Confirmations as c
on
    s.user_id = c.user_id
group by
    s.user_id
```

---

### 3、求出最终答案

> 有了confirmed数和action总数，相除就可以得出最终的答案，但是由于前面用sum求confirmed时没有action的记录也就根本没有计算的数量默认给了null最后除的时候我们需要用ifnull函数给这个空值赋值
>
> 同时要注意四舍五入用round函数来保留两位小数

```mysql
# Write your MySQL query statement below
select
    s.user_id, 
    ifnull(round(sum(action = 'confirmed') / count(s.user_id), 2), 0) as confirmation_rate 
from
    Signups as s
left join
    Confirmations as c
on
    s.user_id = c.user_id
group by
    s.user_id
```

----

## 法2——avg求平均

> 将action为confirmed看做值1，其余看做0，那么直接用avg求平均就可以非常巧妙的算出confirmed率

```mysql
SELECT
    s.user_id,
    ROUND(IFNULL(AVG(c.action='confirmed'), 0), 2) AS confirmation_rate
FROM
    Signups AS s
LEFT JOIN
    Confirmations AS c
ON
    s.user_id = c.user_id
GROUP BY
    s.user_id
```

