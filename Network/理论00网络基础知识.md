# 七层网络模型

1. 应用层：提供应用程序之间的通讯，常见的有HTTP、HTTPS、FTP、DNS、DHCP
2. 表示层：提供数据格式转换服务，常见的有数据加解密、数据解压缩、图片/视频编解码
3. 会话层：建立、维护、管理会话，常见的有服务器验证用户登录、断点续传
4. 传输层：提供进程之间的逻辑通讯：常见的有TCP、UDP、进程、端口、socket
5. 网络层：寻址和如有选择，分组转发数据，常见的有路由器、多层交换机、防火墙、IP
6. 数据链路层：提供链路管理（数据分帧、物理地址寻址mac、重发等），常见的有网卡、二层交换机
7. 物理层：提供比特流传输，常见的有网线、光缆

# 数据包在传输过程中的变化

* 传输层中的数据称为报文段
* 网络层中的数据称为数据段
* 物理层的数据称为帧或者数据帧
	ARP协议

# ARP协议

> address resolutio protocol：地址解析协议

根据IP地址获取物理地址的一个TCP/IP协议

## ARP代理

ARP请求是广播的，若要查询的IP地址在外网，则路由器会代替本地网络上的主机回应（也就是两边的媒婆），该路由器就是ARP代理

## 免费ARP

主机开机配置时，会发送一个目的IP地址为自己IP地址的ARP请求报文，该报文就是免费ARP
作用有：

1. 让主机确认本地网络上是否有与自己IP地址相同的主机，若有，则返回一个错误报文
2. 让其他接受主机的ARP缓存更新IP－MAC对
	DNS协议

# DNS协议

> Domain name resolution：域名解析协议

将域名转换成IP地址

> 域名：我们平时使用的www.baidu.com之类的网址

# 子网划分

## IP地址分类

IP地址分为5类：A B C D E

* A：公网上的IP
* B：国际大公司或者政府
* C：小公司，校园网，科研单位或者小型局域网
* D：组播会使用的地址
* E：保留地址

**注意：0.0.0.0到0.255.255.255地址是存在的，只不过比较特殊，被保留了**

## 记忆技巧

我们只需要记住每一类开始地址的第一个数即可，比如：A的开始地址是1，B的开始地址是128，C的开始地址是192，D的开始地址是224，E的开始地址是240
我们都知道每一个都是8位
用二进制表示就是：

* A：0000 0001
* B：1000 0000
* C：1100 0000
* D：1110  0000
* E：1111 0000

然后很容易记忆：

* A：1.0.0.0 - 127.255.255.255
* B：128.0.0.0 - 191.255.255.255
* C：192.0.0.0 - 223.255.255.255
* D：224.0.0.0 - 239.255.255.255
* E：240.0.0.0 - 255.255.255.255

**注意：127.0.0.1是特殊地址，是测试用的系统回环地址**

## 子网掩码

### 默认子网掩码

* A类：255.0.0.0
* B类：255.255.0.0
* C类：255.255.255.0

## 网关

网关
网管都是具有路由功能的IP地址，默认的主机号都是0

> 主机号：除去子网掩码后剩下来的位数

## 广播地址

会将数据发送给子网内所有主机

主机号部分全为1，也就是直接广播

### 有限广播地址

32位全为1（即255.255.255.255）

用于本网广播

# 以太网帧结构

- MTU:一个网络包的最大长度，以太网一般为1500字节
- MSS：除去IP和TCP头部后，一个网络包所能容纳的TCP数据的最大长度

MSS的最大大小 = 1500 - 20（IP头最小） - 20（TCP头最小） = 1460

# IP协议格式

- 版本：4位，指IP协议的版本，如IPv4，IPv6
- 首部长度：4位，最大值为15个单位（一个单位4个字节），所以最大首部长度为60字节
- 区分服务：8位，不常用
- 总长度：16位，首部和数据之和的长度，也就是每一份信息的大小。数据包长度为65535字节。总长度不超过MTU（1500字节）
- 标识：16位，每发送一个报文，值就会+1，若要发送的信息超过了MTU就会进行分片，这个值就会被分到所有数据分片的标识字段中，最终通过这个标号把所有的信息串起来合成完整的信息
- 标志：3位，只有前两位有意义
- 片位移：12位，指较长的分组在分片后在原分组中的相对位置，以8个字节为偏移单位，比如总共有3800个字节，分三段，每段发1400个字节，那么第一个数据段的片位移 = 0 / 8 = 0，第二段的片位移 = 1400 / 8 = 175, 第三段的片位移 = 2800 / 8 = 350
- 生存时间（TTL）：8位，IP报文所允许通过的路由器的最大数量，每经过一个路由器TTL减一，当为0时，路由器将该数据报丢弃
- 协议：8位，指出携带的数据使用的是哪种协议，TCP为6，UDP为17
- 首部校验和：16位，计算IP头部的校验和，检查IP报头的完整性
- 源IP地址：4字节
- 目的IP地址：4字节
- 可选字段：最多40字节

**注意：IP头大小最小20字节，可选字段最大40字节，于是IP头的范围为20 - 60字节**

# TCP协议格式

- 源端口号：16位
- 目的端口号：16位
- TCP序号：32位，发送的TCP的序号，从0开始，实际这个值就是数据报中内容的字节数，比如第一个包sq = 0，内容为20字节，那么下一个数据报的sq = 21
- 捎带的确认（ack）：32位，确认收到上一个数据报ack的值是指定自己想要收到的下一个数据报的sq，例如，收到的数据报sq为0，长度为20字节，那么ack应该是21
- 首部长度：4位，表名TCP头部的长度，单位也是8字节
- 保留：6位
- falg：6位
- 窗口大小：16位，指定了从被确认的字节算起可以发送多少个字节、
- 校验和：16位
- 紧急指针：16位，指向数据报中紧急数据最后一个字节的下一个字节

## 标志位

1. URG：紧急标志位，置1代表紧急指针生效
2. ACK：置1表示当前的包为确认包，确认序列号生效
3. PSH：置1代表包中数据需要应用层尽快处理，不需要等到接收缓冲区填满就传递给应用层
4. RST：置1，表示需要重新连接
5. SYN：置1表示当前包时建立连接使用的
6. FIN：置1表示包时断开连接用的

# UDP数据报

## 阻塞&非阻塞

这个可以由socket控制，socket的默认属性就是阻塞的

要设置成非阻塞的需要调用`ioctlsocket`方法

```c++
// 把套接字设置成非阻塞
u_long iMode = 1;
ioctlsocket(sock, FIONBIO, &iMode); 
```

> 这里imode = 1就是非阻塞
>
> imode = 0就是阻塞

## 缓冲区

创建一个套接字就会有两个缓冲区，发送缓冲区和接收缓冲区

阻塞模式下的sendto就是如果缓冲区没有足够的空间，则等到空间足够大后再把数据放入发送缓冲区；非阻塞模式下的sendto是只要有数据就放，能放多少放多少，放完后立即返回，返回值是实际放入发送缓冲区中的大小

缓冲区的值是一次性全部发出，和一次性全部读取的

如果程序中的recebuf定义的是10字节，发送过来了100字节，则只会读10字节，剩下的全部舍弃，缓冲区也会清空，recefrom也会再次进入阻塞

同样的如果程序中的recebuf定义的是100字节，发送了10字节，也只会完全读出10字节并返回，然后再次进入阻塞，等待接收下次信息

## 特点

1. 面向非连接
2. 通讯方式为数据报文，数据包不可拆分
3. 传输效率高
4. 会丢包也有可能乱序
